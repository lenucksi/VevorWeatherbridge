name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          CHANGELOG_FILE="vevor-weatherbridge/CHANGELOG.md"
          awk "/## \[$VERSION\]/{flag=1; next} /## \[/{flag=0} flag" "$CHANGELOG_FILE" > /tmp/changelog_entry.md
          cat > /tmp/release_notes.md << EOF
          # VEVOR Weatherbridge v$VERSION
          
          $(cat /tmp/changelog_entry.md)
          
          ## Installation
          
          ### Home Assistant Addon
          
          1. Update the addon to v$VERSION in Home Assistant
          2. Restart the addon
          3. Check the logs for any errors
          
          ### Docker Image
          
          \`\`\`bash
          docker pull ghcr.io/lenucksi/vevor-weatherbridge-amd64:$VERSION
          \`\`\`
          
          Available architectures: \`amd64\`, \`armv7\`, \`aarch64\`, \`armhf\`, \`i386\`
          
          ## Full Changelog
          
          See [CHANGELOG.md](https://github.com/lenucksi/VevorWeatherbridge/blob/main/vevor-weatherbridge/CHANGELOG.md) for complete version history.
          EOF

      - name: Get contributors and commits
        id: git_info
        run: |
          PREV_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")
          if [ -n "$PREV_TAG" ]; then
            RANGE="$PREV_TAG..${{ steps.get_version.outputs.TAG }}"
          else
            RANGE="${{ steps.get_version.outputs.TAG }}"
          fi
          
          # Contributors
          git log $RANGE --format='%an' --no-merges | sort -u | sed 's/^/- @/' > /tmp/contributors.txt
          
          # Commits
          git log $RANGE --pretty=format:"- %s (%h)" --no-merges > /tmp/commits.txt
          
          # Append to release notes
          cat >> /tmp/release_notes.md << EOF
          
          ## Contributors
          
          $(cat /tmp/contributors.txt)
          
          ## Commits
          
          $(cat /tmp/commits.txt)
          
          **Full Diff**: https://github.com/lenucksi/VevorWeatherbridge/compare/${PREV_TAG:-initial}...${{ steps.get_version.outputs.TAG }}
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: /tmp/release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
