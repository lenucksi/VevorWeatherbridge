name: Update Dependencies

on:
  schedule:
    # Run every Sunday at 02:00 UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force dependency update check'
        required: false
        default: 'false'

permissions:
  contents: read

jobs:
  check-updates:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.14'

      - name: Install pip-check-updates equivalent
        run: |
          pip install --upgrade pip
          pip install pip-outdated

      - name: Check for Python package updates
        id: check_python
        run: |
          echo "## Python Package Updates Available" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Install current dependencies
          pip install -r vevor-weatherbridge/requirements.txt

          # Check for outdated packages
          pip list --outdated --format=markdown >> $GITHUB_STEP_SUMMARY || true

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Note:** Renovate bot will automatically create PRs for these updates on the next scheduled run." >> $GITHUB_STEP_SUMMARY

      - name: Check Docker base image updates
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Docker Base Image Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Extract current Python version from Dockerfile
          echo "Current base images used:" >> $GITHUB_STEP_SUMMARY
          echo "- ghcr.io/home-assistant/amd64-base-python:3.12-alpine3.19" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ **Note:** Renovate bot will track updates to Home Assistant base images." >> $GITHUB_STEP_SUMMARY

      - name: Security vulnerability check
        run: |
          pip install pip-audit

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Security Vulnerabilities" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          pip-audit --format markdown >> $GITHUB_STEP_SUMMARY || echo "âœ… No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
